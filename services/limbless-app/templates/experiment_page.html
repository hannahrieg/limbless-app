{% from "components/metadata_group.jinja2" import metadata_group, metadata_group_link, metadata_group_email_link %}
{% from "components/files_tab.jinja2" import files_tab %}
{% from "components/comments_tab.jinja2" import comments_tab with context %}
{% from "components/tooltip.jinja2" import tooltip %}
{% from "components/status_bar.jinja2" import experiment_status_bar with context %}
{% from "components/spinner.jinja2" import spinner %}

{% extends "base.html" %}
{% set active_page = "experiments-page" %}
{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>{{ experiment.name }} <span class="desc">{{ experiment.workflow.name }}</span></h1>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#experiment-form-popup">
                Edit Experiment
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#experiment-file-form-popup">
                Add File
            </button>
            <span
            {% if not experiment.is_deleteable() %}
            {{ tooltip("Only draft experiments can be deleted.", category="danger") }}
            {% endif %}>
                <button type="button" class="btn btn-danger"
                    hx-delete="{{ url_for('experiments_htmx.delete', experiment_id=experiment.id) }}" _="on htmx:confirm(issueRequest)
                    halt the event
                    call Swal.fire({
                        title: 'Delete Experiment \'{{ experiment.name }}\'',
                        showDenyButton: true,
                        text: 'Are you sure?',
                        icon: 'question',
                        confirmButtonText: 'Yes',
                        denyButtonText: 'No'
                    })
                    if result.isConfirmed issueRequest()"
                    {% if not experiment.is_deleteable() %}disabled{% endif %}>
                    Delete Experiment
                </button>
            </span>
        </div>
    </div>

    <div class="status_bar">
        {{ experiment_status_bar(experiment) }}
    </div>

    <div>
        <ul class="nav nav-tabs" id="auth-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pools-tab-btn" data-bs-toggle="tab" data-bs-target="#pools-tab"
                    type="button" role="tab" aria-controls="pools-tab" aria-selected="true">
                    Pools
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#workflows-tab"
                    type="button" role="tab" aria-controls="workflows-tab" aria-selected="false">
                    Workflows
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="metadata-tab-btn" data-bs-toggle="tab" data-bs-target="#metadata-tab"
                    type="button" role="tab" aria-controls="metadata-tab" aria-selected="false">
                    Metadata
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                    data-bs-target="#experiment-overview-tab" type="button" role="tab"
                    aria-controls="experiment-overview-tab" aria-selected="true"
                    hx-get="{{ url_for('experiments_htmx.overview', experiment_id=experiment.id) }}"
                    hx-target="#experiment-overview-graph-container" hx-trigger="click once"
                    hx-swap="innerHTML">
                    Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                    data-bs-target="#experiment-files-tab" type="button" role="tab"
                    aria-controls="experiment-files-tab" aria-selected="true"
                    id="experiment-files-tab-btn">
                    Files
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-comments-tab" type="button" role="tab"
                aria-controls="experiment-comments-tab" aria-selected="true"
                id="experiment-comments-tab-btn">
                    Comments
                </button>
            </li>
            {% if experiment.seq_run %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-seq_run-tab" type="button" role="tab"
                aria-controls="experiment-seq_run-tab" aria-selected="true"
                id="experiment-seq_run-tab-btn">
                    Run
                </button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-num_reads-tab" type="button" role="tab"
                aria-controls="experiment-num_reads-tab" aria-selected="true"
                id="experiment-num_reads-tab-btn">
                    # Reads
                </button>
            </li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="pools-tab" role="tabpanel" tabindex="0">
                <div class="d-flex justify-content-between">
                    <div>
                        <h2>Pools <img {{ tooltip('Right click on a pool name to remove.', 'right') }} src="{{ url_for('static', filename='images/info.svg' )}}" style="width: 20px;"></h2>
                    </div>
                    <div>
                    </div>
                </div>
                <div class="flowcell-capacity-container pb-3">
                    {% for lane in range(1, experiment.num_lanes + 1) %}
                    {% set m_reads_selected, reads_used_pct = lane_capacities[lane] %}
                    <div class="progress relative-progress flowcell-capacity-bar" role="progressbar" aria-valuenow="{{ reads_used_pct }}" aria-valuemin="0" aria-valuemax="100" style="height: 25px;">
                        <div class="progress-title">
                            <b>Lane {{ lane }}</b> Capacity: {{ "%0.1f" % reads_used_pct }}% (Flowcell: <b>{{ experiment.flowcell_type.name }}</b> &mdash; {{ m_reads_selected | int }}/{{ experiment.flowcell_type.max_m_reads_per_lane }} Million Reads)
                        </div>
                        <div class="progress-bar progress-bar-striped text-dark {% if reads_used_pct < 100 %}bg-cemm-blue{% else %}bg-cemm-red{% endif %}" style="width: {{ reads_used_pct }}%;">
                        </div>  
                    </div>
                    {% endfor %}
                </div>
                {% set lanes = experiment.lanes %}
                {% include "components/tables/experiment-pool.html" %}
            </div>
            <div class="tab-pane fade" id="workflows-tab" role="tabpanel" tabindex="1">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>Workflows</h3>
                    </div>
                </div>
                <div class="workflow-container">
                    <div class="card{% if pools | length > 0 %} workflow-completed{% endif %}"
                        hx-get="{{ url_for('select_experiment_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#add-pools-container" data-bs-toggle="modal"
                        data-bs-target="#add-pools-popup">
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/select.svg') }}" width="90px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">1. Add Pools</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Select pools for sequencing.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card{% if all_pools_laned == false %} text-muted disabled{% endif %}"
                        {% if all_pools_laned == true %}
                        data-bs-toggle="modal" data-bs-target="#check_barcode_clashes-workflow-popup"
                        hx-get="{{ url_for('check_barcode_clashes_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#check_barcode_clashes-workflow-container" hx-swap="innerHTML"
                        {% else %}
                        {{ tooltip("All pools must be assigned atleast one lane.", category="warning") }}
                        {% endif %}>
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/clash.svg') }}" width="90px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">2. Check Barcode Clashes</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Checks barcode conflicts, in preparation for pooling libraries.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card{% if all_pools_qced %} workflow-completed{% endif %}"
                        data-bs-toggle="modal" data-bs-target="#pool_qc-workflow-popup"
                        hx-get="{{ url_for('pool_qc_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#pool_qc-workflow-container" hx-swap="innerHTML">
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/qc.svg') }}" width="120px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">3. QC Pools</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Input Pool QC-metrics in preparation for dilution and laning.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card"
                        data-bs-toggle="modal" data-bs-target="#dilute_pools-workflow-popup"
                        hx-get="{{ url_for('dilute_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#dilute_pools-workflow-container" hx-swap="innerHTML">
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/dilute.svg') }}" width="90px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">4. Dilute Pools</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Dilute pools to reasonable concentration.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card{% if can_be_loaded == false %} text-muted disabled{% endif %}{% if laning_completed %} workflow-completed{% endif %}"
                        {% if can_be_loaded == true %}
                        data-bs-toggle="modal" data-bs-target="#lane_pools-workflow-popup"
                        hx-get="{{ url_for('lane_pools_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#lane_pools-workflow-container" hx-swap="innerHTML"
                        {% endif %}
                        {% if all_pools_laned == false and all_pools_qced == false %}
                        {{ tooltip("All pools must be assigned atleast one lane and 'QC Pools'-workflow must be completed.", category="warning") }}
                        {% elif all_pools_laned == false %}
                        {{ tooltip("All pools must be assigned atleast one lane.", category="warning") }}
                        {% else %}
                        {{ tooltip("'QC Pools'-workflow must be completed first.", category="warning") }}
                        {% endif %}>
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/calculator.svg') }}" width="90px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">5. Lane Pools</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Calculates pooling ratios, in preparation for sequencing multiple pools on a single lane.</p>
                            </div>
                        </div>
                    </div>
                    <div
                    class="card{% if can_be_loaded == false %} text-muted disabled{% endif %}{% if all_lanes_qced %} workflow-completed{% endif %}"
                        {% if can_be_loaded == true %}
                        data-bs-toggle="modal" data-bs-target="#lane_qc-workflow-popup"
                        hx-get="{{ url_for('lane_qc_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#lane_qc-workflow-container" hx-swap="innerHTML"
                        {% else %}
                        {{ tooltip("'Lane Pools'-workflow must be completed first.", category="warning") }}
                        {% endif %}>
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/qc.svg') }}" width="120px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">6. QC Lanes</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Input QC-metrics in preparation for loading of the flow cell.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card{% if all_lanes_qced == false %} text-muted disabled{% endif %}{% if flowcell_is_loaded %} workflow-completed{% endif %}"
                        {% if all_lanes_qced == true %}
                        data-bs-toggle="modal" data-bs-target="#load_flow_cell-workflow-popup"
                        hx-get="{{ url_for('load_flow_cell_workflow.begin', experiment_id=experiment.id) }}"
                        hx-target="#load_flow_cell-workflow-container" hx-swap="innerHTML"
                        {% else %}
                        {{ tooltip("'QC Lanes'-workflow must be completed first.", category="warning") }}
                        {% endif %}>
                        <div class="card-icon">
                            <img src="{{ url_for('static', filename='images/licensed/sequencer.svg') }}" width="80px">
                        </div>
                        <div class="card-body">
                            <div class="title-container">
                                <h5 class="card-title">7. Load Flow Cell</h5>
                            </div>
                            <div class="text-container">
                                <p class="card-text">Dilute lanes in preparation for loading of the flow cell.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="metadata-tab" role="tabpanel" tabindex="2">
                <div class="row">
                    {{
                        metadata_group_link(
                            "Operator", experiment.operator.name,
                            url_for("users_page.user_page", user_id=experiment.operator.id),
                            class="col"
                        )
                    }}
                    {{
                        metadata_group_email_link(
                            "Operator Email", experiment.operator.email, class="col",
                            subject="BSF Sequencing Experiment: " + experiment.id | string
                        )
                    }}
                </div>
                <div class="row">
                    {{ metadata_group("Created", experiment.timestamp_created_str(), class="col-3") }}
                    {{
                        metadata_group_link(
                            "Sequencer", experiment.sequencer.name,
                            url_for("devices_page.sequencer_page", sequencer_id=experiment.sequencer.id),
                            class="col-3"
                        )
                    }}
                    {{ metadata_group("Flow Cell", experiment.flowcell_type, class="col-2") }}
                    {{ metadata_group("Workflow", experiment.workflow, class="col-2") }}
                    {{ metadata_group("Lanes", experiment.num_lanes, class="col-2") }}
                </div>
                <div class="row">
                    {{ metadata_group("R1 Cycles", experiment.r1_cycles, class="col") }}
                    {{ metadata_group("I1 Cycles", experiment.i1_cycles, class="col") }}
                    {{ metadata_group("I2 Cycles", experiment.i2_cycles, class="col") }}
                    {{ metadata_group("R2 Cycles", experiment.r2_cycles, class="col") }}
                </div>
            </div>
            <div class="tab-pane fade" id="experiment-overview-tab" role="tabpanel" tabindex="3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>Overview</h2>
                    </div>
                </div>
                <div id="experiment-overview-graph-container">
                    {{ spinner() }}
                </div>
            </div>
            <div class="tab-pane fade" id="experiment-files-tab" role="tabpanel" tabindex="4">
                {{
                    files_tab(
                        context_name="experiment", files=experiment.files,
                        delete_url="experiments_htmx.delete_file",
                        delete_context={"experiment_id": experiment.id},
                        context={ "experiment": experiment }
                    )
                }}
            </div>
            <div class="tab-pane fade" id="experiment-comments-tab" role="tabpanel" tabindex="5">
                {{
                    comments_tab(context="experiment", comments=experiment.comments)
                }}
            </div>  
            {% if experiment.seq_run %}
            <div class="tab-pane fade" id="experiment-seq_run-tab" role="tabpanel" tabindex="6">
                <div class="row">
                    {{ metadata_group("Run Folder", experiment.seq_run.run_folder, class="col") }}
                    {{ metadata_group("Flowcell ID", experiment.seq_run.flowcell_id, class="col") }}
                    {{ metadata_group("Read Type", experiment.seq_run.read_type.name, class="col") }}
                </div>
                <div class="row">
                    {{ metadata_group("RTA Version", experiment.seq_run.rta_version, class="col") }}
                    {{ metadata_group("Recipe Version", experiment.seq_run.recipe_version, class="col") }}
                    {{ metadata_group("Side", experiment.seq_run.side, class="col") }}
                    {{ metadata_group("Mode", experiment.seq_run.flowcell_mode, class="col") }}
                </div>
                <div class="row">
                    {{ metadata_group("R1 Cycles", experiment.seq_run.r1_cycles, class="col") }}
                    {{ metadata_group("I1 Cycles", experiment.seq_run.i1_cycles, class="col") }}
                    {{ metadata_group("I2 Cycles", experiment.seq_run.i2_cycles, class="col") }}
                    {{ metadata_group("R2 Cycles", experiment.seq_run.r2_cycles, class="col") }}
                </div>
            </div>  
            {% endif %}
            <div class="tab-pane fade" id="experiment-num_reads-tab" role="tabpanel" tabindex="7">
                {% include "components/plots/experiment_library_reads.html" %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="experiment-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Edit Experiment</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% include "forms/experiment.html" %}
                </div>
                <div class="modal-footer" id="popup-footer">
                    <button id="submit-experiment-btn" class="btn btn-primary" hx-include="#experiment-form"
                        hx-target="#experiment-form" hx-swap="outerHTML"
                        hx-post="{{ url_for('experiments_htmx.edit', experiment_id=experiment.id) }}">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pooling-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered">
            {% include pooling_input_form._template_path %}
        </div>
    </div>

    <div class="modal fade" id="experiment-file-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered">
            {% include file_input_form._template_path %}
        </div>
    </div>

    <!-- WORKFLOWS -->

    <!-- Add Pools -->
    <div class="modal fade" id="add-pools-popup" aria-hidden="true" aria-labelledby="" tabindex="-1" data-bs-keyboard="false">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered" id="add-pools-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Check Barcode Clashes -->
    <div class="modal fade" id="check_barcode_clashes-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered" id="check_barcode_clashes-workflow-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Pool QC -->
    <div class="modal fade" id="pool_qc-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered" id="pool_qc-workflow-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Dilute Pools -->
    <div class="modal fade" id="dilute_pools-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered" id="dilute_pools-workflow-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Lane Pools -->
    <div class="modal fade" id="lane_pools-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered" id="lane_pools-workflow-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Lane QC -->
    <div class="modal fade" id="lane_qc-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-xl-down modal-dialog-centered" id="lane_qc-workflow-container">
            {{ spinner() }}
        </div>
    </div>

    <!-- Load Flow Cell -->
    <div class="modal fade" id="load_flow_cell-workflow-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered" id="load_flow_cell-workflow-container">
            {{ spinner() }}
        </div>
    </div>
</div>
<script>
    init_tooltips();
    $(document).ready(function() {
        $("#add-pools-popup").on("hide.bs.modal", function() {
            console.log("modal closed");
            location.reload();
        });
    });
</script>
{% endblock content %}