{% from 'components/metadata_group.jinja2' import metadata_group, metadata_group_link, metadata_group_email_link %}
{% from 'components/files_tab.jinja2' import files_tab %}
{% from 'components/comments_tab.jinja2' import comments_tab with context %}
{% from 'components/tooltip.jinja2' import tooltip %}
{% from "components/status_bar.jinja2" import experiment_status_bar with context %}

{% extends "base.html" %}
{% set active_page = "experiments-page" %}
{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>{{ experiment.name }}</h1>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#experiment-form-popup">
                Edit Experiment
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#experiment-file-form-popup">
                Add File
            </button>
            <span
            {% if not experiment.is_deleteable() %}
            {{ tooltip("Only draft experiments can be deleted.", category="danger") }}
            {% endif %}>
                <button type="button" class="btn btn-danger"
                    hx-delete="{{ url_for('experiments_htmx.delete', experiment_id=experiment.id) }}" _="on htmx:confirm(issueRequest)
                    halt the event
                    call Swal.fire({
                        title: 'Delete Experiment',
                        showDenyButton: true,
                        text: 'Proceed?',
                        confirmButtonText: 'Yes',
                        denyButtonText: 'No'
                    })
                    if result.isConfirmed issueRequest()"
                    {% if not experiment.is_deleteable() %}disabled{% endif %}>
                    Delete Experiment
                </button>
            </span>
        </div>
    </div>

    <div class="status_bar">
        {{ experiment_status_bar(experiment) }}
    </div>

    <div>
        <ul class="nav nav-tabs" id="auth-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pools-tab-btn" data-bs-toggle="tab" data-bs-target="#pools-tab"
                    type="button" role="tab" aria-controls="pools-tab" aria-selected="true">
                    Pools</button>
            </li>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="libraries-tab-btn" data-bs-toggle="tab" data-bs-target="#libraries-tab"
                    type="button" role="tab" aria-controls="libraries-tab" aria-selected="true">
                    Libraries</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="metadata-tab-btn" data-bs-toggle="tab" data-bs-target="#metadata-tab"
                    type="button" role="tab" aria-controls="metadata-tab" aria-selected="false">
                    Metadata</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-overview-tab" type="button" role="tab"
                aria-controls="experiment-overview-tab" aria-selected="true"
                id="experiment-overview-tab-btn">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-files-tab" type="button" role="tab"
                aria-controls="experiment-files-tab" aria-selected="true"
                id="experiment-files-tab-btn">Files</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-comments-tab" type="button" role="tab"
                aria-controls="experiment-comments-tab" aria-selected="true"
                id="experiment-comments-tab-btn">Comments</button>
            </li>
            {% if experiment.seq_run %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-seq_run-tab" type="button" role="tab"
                aria-controls="experiment-seq_run-tab" aria-selected="true"
                id="experiment-seq_run-tab-btn">Run</button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#experiment-num_reads-tab" type="button" role="tab"
                aria-controls="experiment-num_reads-tab" aria-selected="true"
                id="experiment-num_reads-tab-btn"># Reads</button>
            </li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="pools-tab" role="tabpanel" tabindex="0">
                <div class="d-flex justify-content-between">
                    <div>
                        <h2>Pools</h2>
                    </div>
                    <div>
                    </div>
                </div>
                {% include "components/tables/experiment-pool.html" %}
            </div>
            <div class="tab-pane fade show" id="libraries-tab" role="tabpanel" tabindex="2">
                <div class="d-flex justify-content-between">
                    <div>
                        <h2>Libraries</h2>
                    </div>
                    <div>
                        {% if experiment.is_editable() %}
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#pooling-form-popup">
                            Pool Libraries
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% include "components/tables/experiment-library.html" %}
            </div>
            <div class="tab-pane fade show" id="metadata-tab" role="tabpanel" tabindex="3">
                <div class="row">
                    {{
                        metadata_group_link(
                            "Sequencing Person Name", experiment.operator.name,
                            url_for("users_page.user_page", user_id=experiment.operator.id),
                            class="col"
                        )
                    }}
                    {{
                        metadata_group_email_link(
                            "Sequencing Person Email", experiment.operator.email, class="col",
                            subject="BSF Sequencing Experiment: " + experiment.id | string
                        )
                    }}
                </div>
                <div class="row">
                    {{
                        metadata_group_link(
                            "Sequencer", experiment.sequencer.name,
                            url_for("devices_page.sequencer_page", sequencer_id=experiment.sequencer.id),
                            class="col"
                        )
                    }}
                    {{ metadata_group("Sequencer IP", experiment.sequencer.ip, class="col") }}
                </div>
                <div class="row">
                    {{ metadata_group("Created", experiment.timestamp.strftime('%Y-%m-%d %H:%M'), class="col-3") }}
                    {{ metadata_group("Flowcell Type", experiment.flowcell_type, class="col-4") }}
                    {{ metadata_group("Lanes", experiment.num_lanes, class="col-2") }}
                </div>
                <div class="row">
                    {{ metadata_group("R1 Cycles", experiment.r1_cycles, class="col") }}
                    {{ metadata_group("I1 Cycles", experiment.i1_cycles, class="col") }}
                    {{ metadata_group("I2 Cycles", experiment.i2_cycles, class="col") }}
                    {{ metadata_group("R2 Cycles", experiment.r2_cycles, class="col") }}
                </div>
            </div>
            <div class="tab-pane fade show" id="experiment-overview-tab" role="tabpanel" tabindex="4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>Overview</h2>
                    </div>
                </div>      
                <script src="https://d3js.org/d3.v4.min.js"></script>
                <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>
                <div class="flow-graph-container pt-3" id="graph" style="width: 100%"></div>
            </div>
            <div class="tab-pane fade show" id="experiment-files-tab" role="tabpanel" tabindex="5">
                {{
                    files_tab(
                        context="experiment", files=experiment.files,
                        delete_url="experiments_htmx.delete_file",
                        delete_context={"experiment_id": experiment.id},
                    )
                }}
            </div>
            <div class="tab-pane fade show" id="experiment-comments-tab" role="tabpanel" tabindex="6">
                {{
                    comments_tab(context="experiment", comments=experiment.comments)
                }}
            </div>  
            {% if experiment.seq_run %}
            <div class="tab-pane fade show" id="experiment-seq_run-tab" role="tabpanel" tabindex="7">
                <div class="row">
                    {{ metadata_group("Run Folder", experiment.seq_run.run_folder, class="col") }}
                    {{ metadata_group("Flowcell ID", experiment.seq_run.flowcell_id, class="col") }}
                    {{ metadata_group("Read Type", experiment.seq_run.read_type.name, class="col") }}
                </div>
                <div class="row">
                    {{ metadata_group("RTA Version", experiment.seq_run.rta_version, class="col") }}
                    {{ metadata_group("Recipe Version", experiment.seq_run.recipe_version, class="col") }}
                    {{ metadata_group("Side", experiment.seq_run.side, class="col") }}
                    {{ metadata_group("Mode", experiment.seq_run.flowcell_mode, class="col") }}
                </div>
                <div class="row">
                    {{ metadata_group("R1 Cycles", experiment.seq_run.r1_cycles, class="col") }}
                    {{ metadata_group("I1 Cycles", experiment.seq_run.i1_cycles, class="col") }}
                    {{ metadata_group("I2 Cycles", experiment.seq_run.i2_cycles, class="col") }}
                    {{ metadata_group("R2 Cycles", experiment.seq_run.r2_cycles, class="col") }}
                </div>
            </div>  
            {% endif %}
            <div class="tab-pane fade show" id="experiment-num_reads-tab" role="tabpanel" tabindex="8">
                {% include "components/plots/experiment_library_reads.html" %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="experiment-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Edit Experiment</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% include "forms/experiment.html" %}
                </div>
                <div class="modal-footer" id="popup-footer">
                    <button id="submit-experiment-btn" class="btn btn-primary" hx-include="#experiment-form"
                        hx-target="#experiment-form" hx-swap="outerHTML"
                        hx-post="{{ url_for('experiments_htmx.edit', experiment_id=experiment.id) }}">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pooling-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            {% include pooling_input_form._template_path %}
        </div>
    </div>

    <div class="modal fade" id="experiment-file-form-popup" aria-hidden="true" aria-labelledby="" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            {% include file_input_form._template_path %}
        </div>
    </div>
</div>
<script>
    init_tooltips();
    $(document).ready(function() {
        $(".dataframe").addClass("table table-hover table-cursor").removeClass("dataframe");
        $("#experiment-overview-tab-btn").on("click", function() {    
            d3.json("{{ url_for('experiments_htmx.get_graph', experiment_id=experiment.id) }}", function(graph) {

                const _h = graph.nodes.length * 50;
                const _w = $("#graph").width();

                var margin = {top: 50, right: 10, bottom: 10, left: 10};
                var width =  _w - margin.left - margin.right;
                var height = _h - margin.top - margin.bottom;

                // append the svg object to the body of the page
                var svg = d3.select("#graph").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

                const dx = width / (5 - 1);

                svg.append("text")
                    .attr("x", 30)
                    .attr("y", -margin.top * 0.5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "22px")
                    .text("Request");

                svg.append("text")
                    .attr("x", dx)
                    .attr("y", -margin.top * 0.5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "22px")
                    .text("Library");

                svg.append("text")
                    .attr("x", dx * 2)
                    .attr("y", -margin.top * 0.5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "22px")
                    .text("Pool");

                svg.append("text")
                    .attr("x", dx * 3)
                    .attr("y", -margin.top * 0.5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "22px")
                    .text("Lane");

                svg.append("text")
                    .attr("x", dx * 4 - 50)
                    .attr("y", -margin.top * 0.5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "22px")
                    .text("Experiment");

                // Color scale used
                var color = d3.scaleOrdinal(d3.schemeCategory20);

                // Set the sankey diagram properties
                var sankey = d3.sankey().nodeWidth(25).nodePadding(15).size([width, height]);

                sankey.nodes(graph.nodes).links(graph.links).layout(20);

                  // add in the links
                var link = svg.append("g")
                    .selectAll(".link")
                    .data(graph.links)
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", sankey.link() )
                    .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                    .sort(function(a, b) { return b.dy - a.dy; });

                
                // add in the nodes
                var node = svg.append("g")
                    .selectAll(".node")
                    .data(graph.nodes)
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                    .call(d3.drag()
                        .subject(function(d) { return d; })
                        .on("start", function() { this.parentNode.appendChild(this); })
                        .on("drag", dragmove));

                // add the rectangles for the nodes
                node
                    .append("rect")
                    .attr("height", function(d) { return d.dy; })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
                    .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
                    // Add hover text
                    .append("title")
                    .text(function(d) { return d.name + "\n" + "There is " + d.value + " stuff in this node"; });

                // add in the title for the nodes
                    node
                    .append("text")
                        .attr("x", -6)
                        .attr("y", function(d) { return d.dy / 2; })
                        .attr("dy", ".35em")
                        .attr("text-anchor", "end")
                        .attr("transform", null)
                        .text(function(d) { return d.name; })
                    .filter(function(d) { return d.x < width / 2; })
                        .attr("x", 6 + sankey.nodeWidth())
                        .attr("text-anchor", "start");

                // the function for moving the nodes
                function dragmove(d) {
                    d3.select(this)
                    .attr("transform",
                            "translate("
                            + d.x + ","
                            + (d.y = Math.max(
                                0, Math.min(height - d.dy, d3.event.y))
                                ) + ")");
                    sankey.relayout();
                    link.attr("d", sankey.link() );
                }

            });          
            $("#experiment-overview-tab-btn").off("click");
        });
    });
</script>
{% endblock content %}