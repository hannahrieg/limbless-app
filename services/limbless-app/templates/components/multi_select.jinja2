{% macro multi_select(choices, field, url, hx_target, selected=none, placeholder="Select...") %}
<div class="dropdown multi-select">
    <button class="dropdown-toggle multi-select-toggle-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" placeholder="{{ placeholder }}">
        {% if selected %}
            {% for choice in selected %}
                {{ choice.select_name }}
            {% endfor %}
        {% else %}
            {{ placeholder }}
        {% endif %}
    </button>
    <ul class="dropdown-menu">
        {% for status in choices %}
        <li>
            <input type="checkbox" class="multi-select-check btn-check" id="select-{{ status.id }}"
            autocomplete="off" icon="{{ status.select_name }}" value="{{ status.id }}"
            {% if selected and status in selected %}checked{% endif %}>
            <label class="btn" for="select-{{ status.id }}">{{ status.display_name }} <span class="desc">{{ status.select_name }}</span></label>
        </li>
        {% endfor %}
    </ul>
</div>
<script>
    $(document).ready(function() {
        $(".multi-select-check").off("click").on("click", function() {
            var button = $(this).parent().parent().parent().find(".multi-select-toggle-btn").first();
            var selected_ids = [];
            var selected = [];

            $(".multi-select-check:checked").each(function() {
                selected.push($(this).attr("icon"));
                selected_ids.push($(this).attr("value"));
            });
            
            if (selected.length == 0) {
                button.text(button.attr("placeholder"));
                button.removeClass("populated");
            } else {
                if (!button.hasClass("populated")) {
                    button.addClass("populated");
                }
                button.text(selected.join(" "));
            }

            htmx.ajax("GET", "{{ url }}", {
                target: "{{ hx_target }}",
                swap: "outerHTML",
                values: {
                    "{{ field }}_in": JSON.stringify(selected_ids)
                }
            });
        });
    });
</script>
{% endmacro %}