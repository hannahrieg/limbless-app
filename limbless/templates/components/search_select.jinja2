{% macro search_select_field(field, url, selected=None, results=None, include_data_element=True, disabled=false, include_field=None, custom_id=None, class="") -%}
{% set field_name = field.name %}
{% if not custom_id %}
    {% set custom_id = field_name %}
{% endif %}
{% set class_str = "form-control search-component search-select-input" + (" disabled" if disabled else "") + (" is-invalid" if (field.errors and not disabled) else "") %}
<div id="{{ custom_id }}-select" class="search-select form-group {{ class }}">
    <label for="{{ custom_id }}">{{ field.label }}</label>
    <div class="input-group">
        <input type="search"
        onclick="this.select();"
        class="{{ class_str }} search-select-input"
        autocomplete="off"
        name="{{ custom_id }}-search"
        id="{{ custom_id }}-search"
        aria-controls="#{{ custom_id }}-results"
        value="{{ selected if selected else '' }}"
        hx-post="{{ url }}"
        hx-include="[name='{{ custom_id }}-search'],[name='library_type']"
        hx-params="{{ custom_id }}-search{{ ',' + include_field if include_field else ''}}"
        hx-target="#{{ custom_id }}-results"
        hx-trigger="keyup changed delay:500ms, {{ custom_id }}, change{{ ', load' if not results else '' }}" 
        hx-swap="innerHTML"
        placeholder="Search"
        {{ "readonly" if disabled }}>
        <div id="{{ custom_id }}-results" class="search-select-results">
            {% include "components/search_select_results.html" %}
        </div>
    </div>
    <div class="invalid-feedback-container" id="{{ custom_id }}-invalid-container">
    {% if field.errors %}
            {% for error in field.errors %}
            <p>{{ error }}</p>
            {% endfor %}
    {% endif %}
    </div>
    {% if include_data_element %}
        {{ field(hidden=False, readonly=True, id=custom_id) }}
    {% endif %}
</div>
<script>
    // Shows search results when user focuses on search component
    $("#{{ custom_id }}-search").on("focus", function() {
        if ($(this).hasClass("disabled")) {
            return;
        }
        $("#{{ custom_id }}-results").css("display", "block");
    });

    $("#{{ custom_id }}-search").on("change", function() {
        if ($(this).val() === "") {
            $("#{{ custom_id }}").val("");
        }
    });
</script>
{%- endmacro %}
